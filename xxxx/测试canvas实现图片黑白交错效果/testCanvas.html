<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>test canvas</title>
</head>
<style>
	*{
		padding: 0;
		margin: 0;
	}
	ul,li{
		text-decoration: none;
		list-style: none;
	}
	html,body{
		height: 100%;
	}
	.outerContainer{
		height: 100%;
		overflow-y: auto;
		overflow-x: hidden;
	}
	.pageHead{
		height: 100%;
		position: relative;
	}
	.colorfulImg, .myCanvas, .headCont{
		width: 100%;
		height: 100%;
	}
	.myCanvas,.colorfulImg{
		position: absolute;
		top: 0;
		left: 0;
		z-index: 100;
	}
	.myCanvas{
		background: transparent;
	}
	.colorfulImg{
		background: url("./back1.png");    
		background-repeat: no-repeat;
    	background-size: 100% 100%;
	}
	.colorfulImg>img{
		width: 600px;
		height: 300px;
		position: absolute;
		top: 50%;
		right:-100px;
		margin-top: -150px;
		transform: rotate(-14deg);
		padding: 20px;
    	background: #efefef;
	}
	.headCont{
		background: transparent;
		overflow: hidden;
		position: relative;
		z-index: 999;
		color: #FAFAFA;
		margin: 0 auto;
		width: 80%;
	}
	.headCont>header{
		display: flex;
		justify-content: space-between;
		padding-top: 20px;
	}
	.headCont>header>h2{
		font-size: 40px;
	}
	.headCont>header>ul{
		height: 60px;
	}
	.headCont>header>ul>li{
		float: left;
		padding: 5px 10px;
		font-size: 18px;
		line-height: 60px;
		cursor: pointer;
	}
	.cont{
		height: 100%;
	}
	#introSelf{
	    background: rgba(255,255,255,.6);
	    width: 65%;
	    margin-top: 60px;
	    height: 75%;
	    box-sizing: border-box;
	    padding: 40px;
	    color: #666;
	}
	#introSelf p{
		height: 40px;
	    line-height: 40px;
	    font-size: 20px;
	    text-indent: 40px;
	}
	#introSelf h2{
	    margin-bottom: 20px;
	}
	/*.headerCont*/
	.aboutMyself{
		background: #FFFFFF;
		height: 500px;
	}
</style>
<body>
	<div class="outerContainer">

		
		<div class="pageHead">
			<div class="colorfulImg">
				<img src="./img.png" alt="">
			</div>
			<canvas id="myCanvas" class="myCanvas"></canvas>
			<div class="headCont">
				<header>
					<h2>Personal <span style="font-size: 20px">view</span></h2>
					<ul>
						<li>主页</li>
						<li>关于我</li>
						<li>工作经历</li>
						<li>项目经验</li>
						<li>自我评价</li>
						<li>联系方式</li>
					</ul>
				</header>
				<section class="cont">
					<div id="introSelf"></div>
				</section>
			</div>
		</div>

		<div class="aboutMyself">
			<p>about myself</p>
		</div>

	</div>
</body>
<script type="text/javascript">
	window.onload = ()=>{

		let domArr = [
			{type:'h2',text:'你好,请先让我做一个自我介绍'},
			{type:'p',text:'姓名 : panyang'},
			{type:'p',text:'年龄 : xx'},
			{type:'p',text:'职业 : 前端开发'},
			{type:'p',text:'xxxx : 巴拉巴拉'},
			{type:'p',text:'xxx : 巴拉巴拉...'},
			{type:'p',text:'xxxx : 巴拉巴拉'},
		];

		function getDPI() {
		    var arrDPI = new Array();
		    if (window.screen.deviceXDPI != undefined) {
		        arrDPI[0] = window.screen.deviceXDPI;
		        arrDPI[1] = window.screen.deviceYDPI;
		    }
		    else {
		        var tmpNode = document.createElement("DIV");
		        tmpNode.style.cssText = "width:1in;height:1in;position:absolute;left:0px;top:0px;z-index:99;visibility:hidden";
		        document.body.appendChild(tmpNode);
		        arrDPI[0] = parseInt(tmpNode.offsetWidth);
		        arrDPI[1] = parseInt(tmpNode.offsetHeight);
		        tmpNode.parentNode.removeChild(tmpNode);
		    }
		    // console.log(arrDPI)
		    return arrDPI;
		}
		// console.log(getDPI());

		// 灰色图片
		const imgGrey = (dataObj,level = 3) => {
			let imdata = dataObj.data;
			let r,g,b,avg;
			// 把图片变为灰色
			for(var p = 0,len = imdata.length; p< len; p += 4){
				r = imdata [p];
				g = imdata [p + 1];
				b = imdata [p + 2];
				avg = Math.floor((r + g + b ) / level);
				if(avg >= 255){
					avg = 255
				}
				imdata [p] = imdata [p + 1] = imdata [p + 2] = avg;
			}
		}

		const clearCircleArea = (ctx,x,y,r) => {    //(x,y)为要清除的圆的圆心，r为半径，cxt为context
		   let stepClear=1;//别忘记这一步  
		   clearArc(x,y,r);
		   function clearArc(x,y,radius){
		      let calcWidth=radius-stepClear;  
		      let calcHeight=Math.sqrt(radius*radius-calcWidth*calcWidth);  

		      let posX=x-calcWidth;  
		      let posY=y-calcHeight;  
		                      
		      let widthX=2*calcWidth;  
		      let heightY=2*calcHeight;  
		                      
		      if(stepClear<=radius){  
		         ctx.clearRect(posX,posY,widthX,heightY);  
		         stepClear+=1;  
		         clearArc(x,y,radius);  
		      }  
		    }  
		}

		// 生成一个临时路径
		class tempPath{

			// 斜率
			constructor(slope,halfRadius,randomLength){
				this.slope = slope;
				this.halfRadius = halfRadius;
				this.randomLength = randomLength;
				this.instance = null;
				this.superimposed = 0;
				this.onlyB = void 0;
			}

			// static createTempPath(slope,halfRadius,randomLength){
			// 	if(this.instance){
			// 		this.instance.slope = slope;
			// 		this.instance.halfRadius = halfRadius;
			// 		this.instance.randomLength = randomLength;
			// 		return this.instance;
			// 	}
			// 	return this.instance = new tempPath(slope,halfRadius,randomLength);
			// }

			// 生成下一个点位置
			generateNextPos(posx,posy){

				if(typeof posx !== "number" || 
				   typeof posy !== "number" ||
				   typeof this.slope !== "number" ||
				   typeof this.halfRadius !== "number"
				) return {posx:void 0,posy:void 0}

				if(!this.onlyB){
					this.onlyB = posy - (this.slope * posx);
				}
				
				let resultX = posx + this.halfRadius;
				let resultY = resultX * this.slope + this.onlyB;
				this.superimposed += this.halfRadius;
				if(this.superimposed >= this.randomLength){
					return void 0;
				}
				return {posx:resultX, posy:resultY}
			}

		}

		let canvasDom = document.querySelector("#myCanvas");
		let canvasDomWidth = myCanvas.offsetWidth;
		let canvasDomHeight = myCanvas.offsetHeight;
		canvasDom.width = canvasDomWidth;
		canvasDom.height = canvasDomHeight;

		let ctx = canvasDom.getContext("2d");

		let cImg = new Image();
		cImg.src = "./back.png";
		// cImg.setAttribute("crossOrigin",'Anonymous');

		function renderDom(parentDom,[...domArr]){
			if(domArr && domArr.length > 0){
				let domObj = domArr[0];
				let appendedDom = parentDom.appendChild(document.createElement(domObj.type));

				async function append(){
					return new Promise((resolve) => {
						let timer = setInterval(function(){
							if(domObj.text.length > 0){
								appendedDom.innerHTML += domObj.text.substr(0,1);
								domObj.text = domObj.text.substr(1);
							}else{
								resolve(true)
								clearInterval(timer);
								timer = null;
							}
						},200);
					})
				}
				
				append().then(res => {
					if(res){
						domArr.shift();
						renderDom(parentDom,domArr)
					}
				})
			}
		}


		// 渲染图片
		cImg.onload = () => {

			renderDom(document.querySelector("#introSelf"),domArr)

			ctx.drawImage(cImg,0,0,canvasDomWidth,canvasDomHeight);
			// let map = ctx.getImageData(0,0,canvasDomWidth,canvasDomHeight);
			// imgGrey(map);
			// ctx.putImageData(map,0,0);
			ctx.globalCompositeOperation = 'destination-out';

			// 以线条方式随机清除canvas
			function clear(posx,posy,path){
				let animateResId = null;
				let randomPointSize = {x : 2, y : 2}
				let randomRadius = Math.ceil(Math.random()) * 6

				clearCircleArea(ctx,posx,posy,randomRadius);
				// console.log(path)
				let nextPos = path.generateNextPos(posx,posy);

				animateResId = window.requestAnimationFrame(function(){
					if(nextPos){
						clear(nextPos.posx,nextPos.posy,path)
					}else{
						window.cancelAnimationFrame(animateResId);
					}
				})
			}


			let i = 0;
			let linesNum = Math.floor(canvasDomHeight);
			
			while(i < linesNum){
				let startPos = {
					x:0,
					y:Math.ceil(Math.floor(canvasDomHeight) * Math.random()),
				}
				let path = new tempPath(0,3,Math.ceil(Math.random() * canvasDomWidth ) / 2 + canvasDomWidth / 2);
				clear(startPos.x, startPos.y, path);
				i++;
			}

		}

		





	}
</script>
</html>